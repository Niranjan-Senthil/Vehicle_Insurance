@model IEnumerable<VehicleInsuranceProject.ViewModels.CustomerPolicyReportViewModel>

@{
    ViewData["Title"] = "My Policy Report";
    Layout = "_Layout"; // Assuming your main customer layout
}

@section Head {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        /* ------------------------------------------------------------------ */
        /* POLISURE POLICY REPORT VIEW - CORAL RED THEME (From Dashboard)     */
        /* ------------------------------------------------------------------ */
        :root {
            --theme-policy-primary: #E74C3C;     /* Coral Red for action/accents (Lighter) */
            --theme-policy-dark: #C0392B;        /* Darker Red for Header/Titles (Maroon) */
            --theme-bg-light: #f4f6f9;           /* Consistent page background */
            --theme-text-dark: #2c3e50;          /* Main content text color */
        }
        
        body {
            background-color: var(--theme-bg-light);
            font-family: 'Inter', sans-serif;
        }

        .report-container { 
            padding: 40px; 
            background-color: #ffffff; /* White background for the content card */
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); 
            margin-top: 30px;
        }

        .report-container h2 {
            color: var(--theme-policy-dark);
            font-weight: 700;
        }

        .table-responsive { margin-top: 20px; }

        /* Themed Header for the Table (Darker Red) */
        .bg-insure-primary { 
            background-color: var(--theme-policy-dark) !important; 
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        } 

        .table thead th {
            font-weight: 600;
            vertical-align: middle;
        }

        /* Status Colors */
        .status-active { color: #059669; font-weight: 600; } /* Dark Green for Active status */
        .status-expired { color: #6c757d; font-weight: 600; } /* Gray */
        .status-cancelled { color: #dc3545; font-weight: 600; } /* Standard Red for Cancelled status */

        .empty-state-section { text-align: center; padding: 50px; color: #6c757d; }
        .empty-state-section i { font-size: 60px; margin-bottom: 20px; color: #ced4da; }
        .empty-state-section a { color: var(--theme-policy-dark); font-weight: 600; text-decoration: none; }
        .empty-state-section a:hover { color: var(--theme-policy-primary); text-decoration: underline; }

        /* Primary Button Style (Download PDF) - Coral Red */
        .btn-primary-custom {
            background-color: var(--theme-policy-primary);
            border-color: var(--theme-policy-primary);
            color: white;
            font-weight: 600;
            padding: 10px 25px;
            border-radius: 8px;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
        }

        .btn-primary-custom:hover {
            background-color: #C0392B; /* Matches dark header on hover */
            border-color: #C0392B;
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(231, 76, 60, 0.6);
        }
        
        /* Alert Styling */
        .alert-danger {
            border-left: 5px solid #dc3545;
        }
    </style>
}

<div class="container report-container">
    <h2 class="mb-4"><i class="bi bi-file-earmark-text-fill me-2"></i> @ViewData["Title"]</h2>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show mt-4" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (Model != null && Model.Any())
    {
        <div class="table-responsive" id="customer-policy-report-table">
            <table class="table table-striped table-hover shadow-sm rounded-3 overflow-hidden">
                <thead class="bg-insure-primary text-white">
                    <tr>
                        <th>Policy Number</th>
                        <th>Vehicle</th>
                        <th>Coverage</th>
                        <th>Premium</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.OrderByDescending(p => p.StartDate))
                    {
                        <tr>
                            <td>@item.PolicyNumber</td>
                            <td>@item.VehicleMake @item.VehicleModel (@item.VehicleRegistrationNumber)</td>
                            <td>@item.CoverageAmount.ToString("C")</td>
                            <td>@item.PremiumAmount.ToString("C")</td>
                            <td>@item.StartDate.ToShortDateString()</td>
                            <td>@item.EndDate.ToShortDateString()</td>
                            <td>
                                @{
                                    string statusClass = "";
                                    switch (item.PolicyStatus)
                                    {
                                        case VehicleInsuranceProject.Repository.Models.PolicyStatus.ACTIVE:
                                            statusClass = "status-active";
                                            break;
                                        case VehicleInsuranceProject.Repository.Models.PolicyStatus.EXPIRED:
                                            statusClass = "status-expired";
                                            break;
                                        case VehicleInsuranceProject.Repository.Models.PolicyStatus.CANCELLED:
                                            statusClass = "status-cancelled";
                                            break;
                                    }
                                }
                                <span class="@statusClass">
                                    @item.PolicyStatus
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        @* Download button using the new custom class *@
        <div class="mt-4 text-end">
            <button id="downloadPdfButton" class="btn btn-primary-custom">
                <i class="bi bi-file-earmark-pdf me-2"></i> Download PDF Report
            </button>
        </div>
    }
    else
    {
        <div class="empty-state-section">
            <i class="bi bi-journal-text"></i>
            <p>You currently have no policies to display in this report.</p>
            <p>Ready to get covered? <a asp-controller="Policy" asp-action="Create">Create a new policy!</a></p>
        </div>
    }
</div>


@section Scripts {
    <!-- html2pdf.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        /* Placeholder function to adhere to the rule of avoiding window.confirm() */
        function showCustomConfirmation(message, callback) {
            // Placeholder: Immediately proceed to download for testing.
            console.log("PDF Confirmation Request:", message);
            callback(true); 
        }

        $(document).ready(function() {
            // Auto-hide alerts
            setTimeout(function() {
                $(".alert-dismissible").fadeTo(500, 0).slideUp(500, function(){
                    $(this).remove();
                });
            }, 7000); // 7 seconds

            // PDF Download Button Click Event
            $("#downloadPdfButton").click(function() {
                // Using the placeholder confirmation function
                showCustomConfirmation("Do you want to download this policy report as a PDF?", function(confirmed) {
                    if (confirmed) {
                        var element = document.getElementById('customer-policy-report-table'); // Target the table-responsive div

                        html2pdf().from(element).set({
                            margin: [30, 10, 5, 10], // Top, Left, Bottom, Right
                            pagebreak: { avoid: 'tr' }, // Avoid breaking rows across pages
                            jsPDF: { orientation: 'landscape', unit: 'pt', format: 'letter', compressPDF: true }
                        }).save('MyPoliciesReport.pdf'); // Automatically save the PDF
                    } else {
                        console.log("PDF download cancelled by user.");
                    }
                });
            });
        });
    </script>
}
