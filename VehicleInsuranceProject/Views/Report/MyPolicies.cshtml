@model IEnumerable<VehicleInsuranceProject.ViewModels.CustomerPolicyReportViewModel>

@{
    ViewData["Title"] = "My Policy Report";
    Layout = "_Layout"; // Assuming your main customer layout
}

@section Head {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .report-container { padding: 30px; background-color: #f8f9fa; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .table-responsive { margin-top: 20px; }
        .bg-insure-primary { background-color: #007bff !important; } /* Adjust to your primary color */
        .status-active { color: #28a745; font-weight: bold; } /* Green */
        .status-expired { color: #6c757d; font-weight: bold; } /* Gray */
        .status-cancelled { color: #dc3545; font-weight: bold; } /* Red for cancelled */
        .empty-state-section { text-align: center; padding: 50px; color: #6c757d; }
        .empty-state-section i { font-size: 60px; margin-bottom: 20px; color: #ced4da; }
    </style>
}

<div class="container report-container">
    <h2 class="mb-4"><i class="bi bi-file-earmark-text-fill me-2"></i> @ViewData["Title"]</h2>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show mt-4" role="alert">
            <i class="bi bi-x-circle-fill me-2"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (Model != null && Model.Any())
    {
        <div class="table-responsive" id="customer-policy-report-table">
            <table class="table table-striped table-hover shadow-sm rounded-3 overflow-hidden">
                <thead class="bg-insure-primary text-white">
                    <tr>
                        <th>Policy Number</th>
                        <th>Vehicle</th>
                        <th>Coverage</th>
                        <th>Premium</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.OrderByDescending(p => p.StartDate))
                    {
                        <tr>
                            <td>@item.PolicyNumber</td>
                            <td>@item.VehicleMake @item.VehicleModel (@item.VehicleRegistrationNumber)</td>
                            <td>@item.CoverageAmount.ToString("C")</td>
                            <td>@item.PremiumAmount.ToString("C")</td>
                            <td>@item.StartDate.ToShortDateString()</td>
                            <td>@item.EndDate.ToShortDateString()</td>
                            <td>
                                @{
                                    string statusClass = "";
                                    switch (item.PolicyStatus)
                                    {
                                        case VehicleInsuranceProject.Repository.Models.PolicyStatus.ACTIVE:
                                            statusClass = "status-active";
                                            break;
                                        case VehicleInsuranceProject.Repository.Models.PolicyStatus.EXPIRED:
                                            statusClass = "status-expired";
                                            break;
                                        case VehicleInsuranceProject.Repository.Models.PolicyStatus.CANCELLED:
                                            statusClass = "status-cancelled";
                                            break;
                                    }
                                }
                                <span class="@statusClass">
                                    @item.PolicyStatus
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        @* Example: Download button *@
        <div class="mt-4 text-end">
            <button id="downloadPdfButton" class="btn btn-primary">
                <i class="bi bi-file-earmark-pdf me-2"></i> Download PDF
            </button>
        </div>
    }
    else
    {
        <div class="empty-state-section">
            <i class="bi bi-journal-text"></i>
            <p>You currently have no policies to display in this report.</p>
            <p>Ready to get covered? <a asp-controller="Policy" asp-action="Create">Create a new policy!</a></p>
        </div>
    }
</div>


@section Scripts {
    <!-- html2pdf.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        $(document).ready(function() {
            // Auto-hide alerts
            setTimeout(function() {
                $(".alert-dismissible").fadeTo(500, 0).slideUp(500, function(){
                    $(this).remove();
                });
            }, 7000); // 7 seconds

            // PDF Download Button Click Event
           $("#downloadPdfButton").click(function() {
                // Ask for confirmation
                if (confirm("Do you want to download this report as a PDF?")) {
                    var element = document.getElementById('customer-policy-report-table'); // Target the table-responsive div

                    html2pdf().from(element).set({
                        margin: [30, 10, 5, 10], // Top, Left, Bottom, Right
                        pagebreak: { avoid: 'tr' }, // Avoid breaking rows across pages
                        jsPDF: { orientation: 'landscape', unit: 'pt', format: 'letter', compressPDF: true }
                    }).save('MyPoliciesReport.pdf'); // Automatically save the PDF
                } else {
                    // User clicked Cancel, do nothing
                    console.log("PDF download cancelled by user.");
                }
            });
        });
    </script>
}